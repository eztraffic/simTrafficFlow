<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>simTrafficFlow | Network Editor</title>

    <!-- 引入字型與圖標 -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto+Mono:wght@500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="style.css">
    <!-- Konva.js Library -->
    <script src="konva.min.js"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- 引入新的 OSM Importer 腳本 (需放在 editor.js 之前) -->
    <script src="osm_importer.js"></script>
</head>

<body>
    <!-- 1. 頂部導航 -->
    <nav class="app-navbar">
        <div class="brand-section">
            <div class="logo-icon"><i class="fa-solid fa-pen-ruler"></i></div>
            <div class="brand-text">
                <h1>simTrafficFlow 路網微觀交通模擬</h1>
                <span class="version-tag">Editor</span>
            </div>
        </div>

        <div class="global-controls">
            <div class="separator"></div>

            <!-- 檔案操作 -->
            <div class="control-group file-inputs">
                <button id="importXmlBtn" class="btn-input secondary" title="Import from .sim">
                    <i class="fa-regular fa-folder-open"></i>
                    <span>Import</span>
                </button>
                <button id="osmImportBtn" class="btn-input secondary" title="Import Map Background">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <span>OSM Map</span>
                </button>
                <button id="exportXmlBtn" class="btn-input primary" title="Export network to .sim file">
                    <i class="fa-solid fa-floppy-disk"></i>
                    <span>Export</span>
                </button>
            </div>

            <!-- [新增] 語言切換區塊 -->
            <div class="separator"></div>
            <div class="control-group">
                <select id="languageSelect" class="dropdown-dark language-select">
                    <option value="zh">繁體中文</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
    </nav>

    <!-- 2. 工具列：採用最早優化方案的分類 (EDIT, ROAD, OBJECTS, UTILS) -->
    <div class="app-toolbar" id="toolbar">

        <!-- 1. EDIT -->
        <div class="toolbar-section">
            <button class="tool-btn active" data-tool="select" title="Select (V)">
                <i class="fa-solid fa-arrow-pointer"></i>
                <span class="btn-text">Select</span>
            </button>
        </div>

        <div class="divider-v"></div>

        <!-- 2. ROAD -->
        <div class="toolbar-section">
            <button class="tool-btn" data-tool="add-link" title="Add Link (L)">
                <i class="fa-solid fa-road"></i>
                <span class="btn-text">Link</span>
            </button>
            <button class="tool-btn" data-tool="connect-lanes" title="Connect Lanes (C)">
                <i class="fa-solid fa-link"></i>
                <span class="btn-text">Connect</span>
            </button>
            <button class="tool-btn" data-tool="add-marking" title="Add Marking (K)">
                <i class="fa-solid fa-lines-leaning"></i>
                <span class="btn-text">Marking</span>
            </button>
        </div>

        <div class="divider-v"></div>

        <!-- 3. OBJECTS -->
        <div class="toolbar-section">
            <button class="tool-btn" data-tool="edit-tfl" title="Traffic Light (T)">
                <i class="fa-solid fa-traffic-light"></i>
                <span class="btn-text">Signal</span>
            </button>
            <button class="tool-btn" data-tool="add-flow" title="Add Flow (F)">
                <i class="fa-solid fa-car-side"></i>
                <span class="btn-text">Flow</span>
            </button>
            <button class="tool-btn" data-tool="add-road-sign" title="Speed Sign (R)">
                <i class="fa-solid fa-sign-hanging"></i>
                <span class="btn-text">Sign</span>
            </button>
            <button class="tool-btn" data-tool="add-point-detector" title="Point Detector (P)">
                <i class="fa-solid fa-video"></i>
                <span class="btn-text">Pt. Det.</span>
            </button>
            <button class="tool-btn" data-tool="add-section-detector" title="Section Detector (S)">
                <i class="fa-solid fa-video-slash"></i>
                <span class="btn-text">Sec. Det.</span>
            </button>
            <button class="tool-btn" data-tool="add-parking-lot" title="Parking Lot (P)">
                <i class="fa-solid fa-square-parking"></i>
                <span class="btn-text">Parking</span>
            </button>
            <button class="tool-btn" data-tool="add-parking-gate" title="Parking Gate (Shift+P)">
                <i class="fa-solid fa-door-open"></i>
                <span class="btn-text">Gate</span>
            </button>
        </div>

        <div class="divider-v"></div>

        <!-- 4. UTILS -->
        <div class="toolbar-section">
            <button class="tool-btn" data-tool="measure" title="Measure (M)">
                <i class="fa-solid fa-ruler"></i>
                <span class="btn-text">Measure</span>
            </button>
            <button class="tool-btn" data-tool="add-background" title="Background Image (B)">
                <i class="fa-regular fa-image"></i>
                <span class="btn-text">Image</span>
            </button>
            <button class="tool-btn" data-tool="add-pushpin" title="Geo Pin (G)">
                <i class="fa-solid fa-thumbtack"></i>
                <span class="btn-text">Geo Pin</span>
            </button>
        </div>

        <!-- [修改位置] 背景鎖定區塊移至最右側 -->
        <!-- margin-left: auto 會將此元素之後的所有內容推到最右邊 -->
        <div class="divider-v" id="bg-lock-divider" style="display:none; margin-left: auto;"></div>

        <div class="toolbar-section" id="bg-lock-section" style="display:none;">
            <label class="tool-check-label" title="Lock Background Image">
                <input type="checkbox" id="bg-lock-checkbox">
                <i class="fa-solid fa-lock-open" id="bg-lock-icon"></i>
                <span class="btn-text">lock(鎖定背景)</span>
            </label>
        </div>
        <!-- [結束修改] -->

    </div>
    <!-- 3. 主內容區 -->
    <main id="main-content">
        <!-- 1. 畫布區 (移至左側/前方) -->
        <div id="canvas-container">
            <div id="status-bar">Ready</div>
        </div>

        <!-- 2. 屬性面板 (移至右側/後方) -->
        <aside id="properties-panel">
            <div class="panel-header">
                <h2>Properties</h2>
                <div id="status-badge" class="live-badge" style="background:var(--text-muted);">READY</div>
            </div>
            <div id="properties-content" class="panel-content">
                <div class="empty-state">
                    <i class="fa-solid fa-arrow-pointer"></i>
                    <p>Select an element to edit</p>
                </div>
            </div>
        </aside>
    </main>

    <!-- Modals -->
    <div id="traffic-light-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tfl-modal-title">Traffic Light Editor</h2>
                <span class="close-button">×</span>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab-link active" data-tab="tfl-grouping">Signal Groups</button>
                    <button class="tab-link" data-tab="tfl-phasing">Phasing Schedule</button>
                </div>
                <div id="tfl-grouping" class="tab-content active">
                    <div class="tfl-column">
                        <h4>Manage Groups</h4>
                        <div id="tfl-group-management"></div>
                        <div class="tfl-add-group input-group">
                            <input type="text" id="tfl-new-group-name" placeholder="Group Name (e.g. S1)">
                            <button id="tfl-add-group-btn" class="btn-primary">Add</button>
                        </div>
                    </div>
                </div>
                <div id="tfl-phasing" class="tab-content">
                    <h4>Phasing Schedule</h4>
                    <div id="tfl-schedule-table-container">
                        <table id="tfl-schedule-table">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <button id="tfl-add-phase-btn" class="btn-secondary" style="margin-top:10px;">+ Add Phase</button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="tfl-save-btn" class="btn-primary">Done</button>
            </div>
        </div>
    </div>

    <!-- Spawner Modal -->
    <div id="spawner-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 id="spawner-modal-title">Vehicle Spawner Editor</h2>
                <span class="close-button">×</span>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab-link active" data-tab="spawner-periods">Time Periods</button>
                    <button class="tab-link" data-tab="spawner-profiles">Vehicle Profiles</button>
                </div>
                <div id="spawner-periods" class="tab-content active">
                    <div id="spawner-periods-list"></div>
                    <button id="spawner-add-period-btn" class="btn-secondary dashed">+ Add Time Period</button>
                </div>
                <div id="spawner-profiles" class="tab-content">
                    <div id="spawner-profiles-list"></div>
                    <button id="spawner-add-profile-btn" class="btn-secondary dashed">+ Add New Profile</button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="spawner-save-btn" class="btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Lane Range Modal (Professional Layout) -->
    <div id="lane-range-modal" class="modal">
        <div id="lane-range-modal-content" class="modal-content small popover-style">
            <div class="modal-header compact">
                <h4 id="lr-modal-title">CONNECTION SETTINGS</h4>
            </div>

            <div class="modal-body" style="padding: 0;">
                <div class="modal-pro-grid">
                    <!-- 左欄：來源 -->
                    <div class="modal-col">
                        <div class="modal-col-header"><i class="fa-solid fa-circle-arrow-right"></i> SOURCE</div>
                        <div class="modal-input-group">
                            <span class="modal-label">Start Lane</span>
                            <input type="number" id="lr-source-start" class="modal-input" value="0" min="0">
                        </div>
                        <div class="modal-input-group">
                            <span class="modal-label">Count</span>
                            <input type="number" id="lr-source-count" class="modal-input" value="1" min="1">
                        </div>
                    </div>

                    <!-- 右欄：目的 -->
                    <div class="modal-col">
                        <div class="modal-col-header"><i class="fa-solid fa-location-dot"></i> DEST</div>
                        <div class="modal-input-group">
                            <span class="modal-label">Start Lane</span>
                            <input type="number" id="lr-dest-start" class="modal-input" value="0" min="0">
                        </div>
                        <div class="modal-input-group">
                            <span class="modal-label">Count</span>
                            <input type="number" id="lr-dest-count" class="modal-input" value="1" min="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer compact">
                <button id="lr-cancel-btn" class="btn-sm btn-cancel">Cancel</button>
                <button id="lr-confirm-btn" class="btn-sm btn-save">Confirm</button>
            </div>
        </div>
    </div>

    <!-- [新增] 引入翻譯引擎 -->
    <script src="i18n.js"></script>

    <!-- OSM Import Modal -->
    <div id="osm-modal" class="modal">
        <div class="modal-content large" style="width: 90%; height: 90%; display:flex; flex-direction:column;">
            <div class="modal-header">
                <h2>Import OpenStreetMap Background</h2>
                <span class="close-button" id="osm-close-btn">×</span>
            </div>
            <div class="modal-body" style="flex:1; display:flex; gap:10px; padding:0;">
                <!-- 左側控制區 -->
                <div style="width: 250px; padding: 15px; background: #f8f9fa; border-right: 1px solid #ddd; display:flex; flex-direction:column; gap:10px;">
                    <div class="input-group">
                        <label>Search Location</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="osm-search-input" placeholder="e.g. Taipei" style="flex:1;">
                            <button id="osm-search-btn" class="btn-secondary"><i class="fa-solid fa-magnifying-glass"></i></button>
                        </div>
                    </div>
                    
                    <hr style="border:0; border-top:1px solid #ddd; margin: 10px 0;">
                    
                    <div id="osm-info-panel" style="font-size: 0.85rem; color: #555;">
                        <p><strong>Bounds (Lat/Lon):</strong><br><span id="osm-bounds-text">-</span></p>
                        <p><strong>Size (Meters):</strong><br><span id="osm-size-text">-</span></p>
                    </div>

                    <div style="margin-top:auto;">
                        <p style="font-size:0.8rem; color:#888;">
                            <i class="fa-solid fa-circle-info"></i> Pan/Zoom to select area. 
                            The visible area will be captured.
                        </p>
                        <button id="osm-capture-btn" class="btn-primary" style="width:100%; justify-content:center;">
                            Import & Calibrate
                        </button>
                    </div>
                </div>
                
                <!-- 右側地圖區 -->
                <div id="osm-map-container" style="flex:1; position: relative;">
                    <div id="osm-map" style="width: 100%; height: 100%;"></div>
                    <!-- 中心十字準星 -->
                    <div style="position:absolute; top:50%; left:50%; width:20px; height:20px; margin-left:-10px; margin-top:-10px; pointer-events:none; z-index:1000;">
                        <svg viewBox="0 0 20 20" style="stroke:red; stroke-width:2;">
                            <line x1="10" y1="0" x2="10" y2="20" />
                            <line x1="0" y1="10" x2="20" y2="10" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="editor.js"></script>
</body>

</html>