<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">simTrafficFlow | 路網微觀交通模擬</title>

    <!-- 引入字型與圖標 -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto+Mono:wght@500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="style01.css">

    <!-- 函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/three@0.147.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.147.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.147.0/examples/js/controls/OrbitControls.js"></script>
</head>

<body>
    <!-- 1. 頂部導航：品牌 + 檔案與全域設定 -->
    <nav class="app-navbar">
        <div class="brand-section">
            <div class="logo-icon"><i class="fa-solid fa-road"></i></div>
            <div class="brand-text">
                <h1>simTrafficFlow 路網微觀交通模擬</h1>
                <span class="version-tag">Simulator</span>
            </div>
        </div>

        <div class="global-controls">
            <!-- 檔案讀取群組 -->
            <div class="control-group file-inputs">
                <label class="btn-input primary" title="載入路網 (.xml/.sim)">
                    <i class="fa-regular fa-folder-open"></i>
                    <span data-i18n="selectFileLabel">路網</span>
                    <input type="file" id="xmlFileInput" accept=".sim,.xml">
                </label>

                <!-- 修正後：只有一層 label -->
                <label class="btn-input secondary" title="Load Scene (.xml)">
                    <i class="fa-solid fa-cube"></i>
                    <span data-i18n="loadSceneLabel">場景</span>
                    <input type="file" id="sceneFileInput" accept=".xml">
                </label>
            </div>

            <div class="separator"></div>

            <!-- Seed 設定 -->
            <div class="control-group seed-settings">
                <label for="citySeedInput">Seed:</label>
                <div class="input-with-action">
                    <input type="number" id="citySeedInput" value="12345">
                    <button id="regenCityBtn" title="重新生成"><i class="fa-solid fa-rotate"></i></button>
                </div>
            </div>

            <!-- 語言 -->
            <div class="control-group">
                <select id="langSelector" class="dropdown-dark">
                    <option value="zh-Hant">繁體中文</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
    </nav>

    <!-- 2. 工具列：模擬控制、視角、圖層 -->
    <div class="app-toolbar">
        <!-- 左：播放與時間 -->
        <div class="toolbar-section playback-controls">
            <button id="startStopButton" class="play-btn" disabled>
                <i class="fa-solid fa-play"></i>
                <span class="btn-text">載入中</span>
            </button>

            <div class="slider-wrapper">
                <i class="fa-solid fa-gauge-high icon-muted"></i>
                <input type="range" id="speedSlider" min="1" max="50" value="3">
                <span id="speedValue" class="value-badge">3x</span>
            </div>

            <div class="time-display">
                <span class="label" data-i18n="simTimeLabel">TIME</span>
                <span id="simulationTime" class="time-value">0.00</span>
                <span class="unit">s</span>
            </div>
        </div>

        <!-- 中：視圖切換 (關鍵功能) -->
        <div class="toolbar-section view-controls">
            <div id="displayModeToggle" class="segment-control" role="group">
                <button type="button" id="displayStatsBtn" class="segment-btn is-active" data-mode="stats">
                    <i class="fa-solid fa-chart-pie"></i>
                </button>
                <button type="button" id="display2DBtn" class="segment-btn is-active" data-mode="2d">
                    2D
                </button>
                <button type="button" id="display3DBtn" class="segment-btn" data-mode="3d">
                    3D
                </button>
            </div>

            <!-- 同步旋轉開關 -->
            <div id="syncRotationContainer" class="icon-toggle" title="2D/3D 同步旋轉">
                <input type="checkbox" id="syncRotationToggle" checked>
                <label for="syncRotationToggle">
                    <i class="fa-solid fa-sync"></i>
                </label>
            </div>
        </div>

        <!-- 右：圖層與顯示 (已修正：包含兩種偵測器) -->
        <div class="toolbar-section layer-controls">
            <div class="control-group">
                <select id="layerSelector" class="dropdown-light">
                    <option value="both" data-i18n="layerBoth">建築 + 底圖</option>
                    <option value="buildings" data-i18n="layerBuildings">僅建築</option>
                    <option value="basemap" data-i18n="layerBasemap">僅底圖</option>
                    <option value="none" data-i18n="layerNone">無背景</option>
                </select>
            </div>

            <div class="toggles-row">
                <!-- 1. 路口燈號 (獨立) -->
                <label class="mini-switch" title="Traffic Lights">
                    <input type="checkbox" id="showPathsToggle">
                    <span class="switch-label" data-i18n="lblLights">燈號</span>
                </label>

                <div class="divider-v"></div>

                <!-- 2. 視角/控制模式 (2x2 Grid) -->
                <div class="mode-grid">
                    <!-- 上排 -->
                    <label class="mini-switch" title="Flyover Mode">
                        <input type="checkbox" id="flyoverToggle">
                        <span class="switch-label" data-i18n="lblFlyover">鳥瞰</span>
                    </label>
                    <label class="mini-switch" title="Drone View">
                        <input type="checkbox" id="droneToggle">
                        <span class="switch-label" data-i18n="lblDrone">無人機</span>
                    </label>

                    <!-- 下排 -->
                    <label class="mini-switch" title="Drive Mode (PS3 Controller)">
                        <input type="checkbox" id="driveToggle">
                        <span class="switch-label">駕駛</span>
                    </label>
                    <label class="mini-switch" title="Police Manual Control">
                        <input type="checkbox" id="policeToggle">
                        <span class="switch-label">員警</span>
                    </label>
                </div>

                <div class="divider-v"></div>

                <!-- 3. 偵測器群組 -->
                <div class="detector-group">
                    <div class="switch-pair">
                        <label class="tiny-switch" title="Point Detectors">
                            <input type="checkbox" id="showPointMetersToggle">
                            <span data-i18n="lblPoint">定點</span>
                        </label>
                        <label class="tiny-switch" title="Section Detectors">
                            <input type="checkbox" id="showSectionMetersToggle">
                            <span data-i18n="lblSection">區間</span>
                        </label>
                    </div>
                    <span class="group-caption" data-i18n="lblDetector">偵測器</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. 主內容區 -->
    <main id="main-content">
        <!-- 左側：統計面板 -->
        <aside id="stats-panel">
            <div class="panel-header">
                <h2 data-i18n="statsTitle">統計數據</h2>
                <div class="live-badge">LIVE</div>
            </div>

            <div class="panel-content">
                <div class="chart-card">
                    <h3 data-i18n="vehicleCountChartTitle">車輛數</h3>
                    <div class="chart-box">
                        <canvas id="vehicleCountChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 data-i18n="avgSpeedChartTitle">平均速度</h3>
                    <div class="chart-box">
                        <canvas id="avgSpeedChart"></canvas>
                    </div>
                </div>

                <!-- 這裡會動態插入 Meter Charts -->
                <div id="meter-charts-container"></div>
                <div id="section-meter-charts-container"></div>

                <div class="table-card">
                    <h3 data-i18n="realtimeStatsTitle">即時紀錄</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th data-i18n="tableHeaderTime">Time</th>
                                    <th data-i18n="tableHeaderVehicles">Veh.</th>
                                    <th data-i18n="tableHeaderAvgSpeed">Km/h</th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 右側：視覺化畫布 (Flex Container) -->
        <div id="canvas-container">
            <!-- 2D Canvas -->
            <canvas id="networkCanvas"></canvas>

            <!-- 3D Container -->
            <div id="threejs-container"></div>

            <!-- 空狀態提示 -->
            <div id="placeholder-text">
                <div class="empty-state-content">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <!-- 加入 data-i18n="canvasPlaceholder" -->
                    <p data-i18n="canvasPlaceholder">請從上方載入路網檔案開始模擬</p>
                </div>
            </div>
        </div>
        <div id="drive-hud" style="display: none;">
            <div class="hud-panel">
                <div id="drive-hud-score" class="hud-text">SCORE: 0</div>
                <div id="drive-hud-speed" class="hud-text">0 KM/H</div>
            </div>
            <div id="drive-hud-message" class="hud-message"></div>
            <div class="hud-controls-hint">
                <p><span class="btn-icon">START</span> 引擎開關</p>
                <p><span class="btn-icon">R2</span> 加速 <span class="btn-icon">L2</span> 煞車</p>
                <p><span class="btn-icon">L-Stick</span> 轉向</p>
            </div>
        </div>
        <div id="police-hud" style="display: none;">
            <div class="hud-panel police-panel">
                <div class="hud-text" style="color: #44aaff;">POLICE MODE</div>
            </div>
            <div id="police-hud-message" class="hud-message"></div>
            <div class="hud-controls-hint">
                <p><span class="btn-icon">點擊</span> 選擇路口</p>
                <p><span class="btn-icon">P</span> 鎖定當前燈號 (凍結)</p>
                <p><span class="btn-icon">N</span> 強制跳下個步階</p>
                <p style="color:#aaa; font-size:0.7em;">(黃燈/全紅期間無法操作)</p>
            </div>
        </div>
    </main>

    <script src="script_police.js"></script>
    <script src="script_drive.js"></script>
    <script src="script02.js"></script>
    <script>
        window.ENABLE_LEFT_TURN_YIELD = true;
        window.MANDATORY_LC_MAX_START_BASE = 1200;
        window.MANDATORY_LC_MAX_START_PER_SHIFT = 400;
        window.MANDATORY_LC_SHORT_LINK_THRESHOLD = 150;
    </script>
</body>

</html>